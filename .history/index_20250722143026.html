<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>

  <title>Erei</title>
  <style>
    body {
      font-family: sans-serif;
      background: #ffffff;
      color: #111;
      margin: 0;
      padding: 0;
    }
    
    #main {
      display: flex;
      flex-direction: column;
      height: 96vh;
      max-width: 800px;
      margin: auto;
    }

    .video-info {
      display: flex;
      gap: 20px;
      margin-top: 8px;
      font-size: 0.8em;
      color: #6e6e6e;
      align-items: center;
    }

    .video-info span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .video-info svg {
      width: 16px;
      height: 16px;
      fill: #555;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .video-container video {
      width: 100%;
      border-radius: 8px;
    }

    .video-container {
      flex-shrink: 0;
      padding: 15px;
    }

    .video-title {
      font-weight: bold;
      font-size: 1.3em;
      margin-top: 10px;
    }

    /* 🆕 TABS STYLING */
    .tabs-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background-color: #f5f5f5;
    }

    .tabs-header {
      display: flex;
      background-color: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      margin: 0 15px;
    }

    .tab-btn {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      color: #333;
      background-color: #f8f9fa;
    }

    .tab-btn.active {
      color: #EA5B5B;
      border-bottom-color: #EA5B5B;
      background-color: #fff;
    }

    .tab-btn iconify-icon {
      font-size: 18px;
    }

    .tabs-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 🆕 COMMENTS STYLING */
    .comments-container {
      max-height: 100%;
      overflow-y: auto;
    }

    .comment-form {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .user-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .instructor-badge {
      background: #28a745;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 8px;
    }

    .comment-form textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }

    .comment-form textarea:focus {
      outline: none;
      border-color: #EA5B5B;
    }

    .comment-form button {
      background: #EA5B5B;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 10px;
    }

    .comment-form button:hover {
      background: #d44848;
    }

    .comment-thread {
      margin-bottom: 20px;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .comment {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .comment:last-child {
      border-bottom: none;
    }

    .main-comment {
      background: #f8f9fa;
    }

    .reply-comment {
      background: #ffffff;
      margin-left: 20px;
      border-left: 3px solid #EA5B5B;
      padding-left: 15px;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .comment-header strong {
      color: #333;
    }

    .comment-time {
      color: #999;
      font-size: 12px;
    }

    .comment-message {
      color: #444;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .comment-actions button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
    }

    .comment-actions button:hover {
      color: #EA5B5B;
    }

    /* OTROS VIDEOS STYLING (tu código existente) */
    .related-item {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      cursor: pointer;
      background: #ffffff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .related-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .related-item.active {
      background-color: #f0f0f0;
      border-left: 4px solid #EA5B5B;
      border-radius: 4px;
      padding-left: 15px;
    }

    .related-item img {
      width: 140px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }

    .related-texts {
      flex-grow: 1;
    }

    .related-texts .name {
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .related-texts .duration {
      font-size: 0.9em;
      color: #555;
    }

    canvas {
      display: none;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state iconify-icon {
      font-size: 48px;
      color: #ccc;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div id="main">
    <!-- Video Container -->
    <div class="video-container">
      <video id="mainVideo" controls autoplay crossorigin="anonymous" playsinline></video>
      <div class="video-title" id="mainTitle"></div>
      <div class="video-info" id="mainInfo"></div>
    </div>

    <!-- Tabs Container -->
    <div class="tabs-container">
      <!-- Tabs Header -->
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="comments">
          <iconify-icon icon="mdi:comment-multiple"></iconify-icon>
          Comentarios
        </button>
        <button class="tab-btn" data-tab="related">
          <iconify-icon icon="mdi:playlist-play"></iconify-icon>
          Otros videos
        </button>
      </div>

      <!-- Tabs Content -->
      <div class="tabs-content">
        <!-- Comments Tab -->
        <div id="comments-tab" class="tab-content active">
          <div class="comments-container">
            <!-- Comment Form -->
            <div class="comment-form">
              <div class="user-info" id="userInfo">
                Comentando como: <strong>Cargando...</strong>
              </div>
              <textarea id="new-comment" placeholder="Escribe tu comentario..."></textarea>
              <button onclick="CommentsManager.submitNewComment()">
                Enviar Comentario
              </button>
            </div>

            <!-- Comments List -->
            <div id="comments-list">
              <!-- Los comentarios se cargan aquí dinámicamente -->
            </div>
          </div>
        </div>

        <!-- Related Videos Tab -->
        <div id="related-tab" class="tab-content">
          <div id="relatedList">
            <!-- Tu código existente de videos relacionados -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <canvas id="captureCanvas"></canvas>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // 🎛️ CONFIGURACIÓN PRINCIPAL
    const ENABLE_PREVIEW_PROCESSING = false // ⚡ Cambiar a true para procesar previews

    const supabase = createClient(
      'https://heuqktyjmrhivmdrbspo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhldXFrdHlqbXJoaXZtZHJic3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODI2MjE0MzcsImV4cCI6MTk5ODE5NzQzN30.VWtsaZwks1WVx1_KH8GjFG85wavsSMV4YWfbEF66BBg'
    )

    const urlParams = new URLSearchParams(window.location.search)
    const program = urlParams.get('program') || '1'
    const currentId = urlParams.get('current') || '1'

    // 🆕 DATOS DE USUARIO
    const currentUser = {
      id: urlParams.get('user_id') || 'user123',
      name: decodeURIComponent(urlParams.get('user_name') || 'Usuario Demo'),
      isInstructor: urlParams.get('is_instructor') === 'true'
    }

    console.log('👤 Usuario actual:', currentUser)

    // 🆕 GESTOR DE TABS
    const TabsManager = {
      init() {
        const tabButtons = document.querySelectorAll('.tab-btn')
        
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab')
            this.switchTab(tabName)
          })
        })
      },

      switchTab(tabName) {
        // Actualizar botones
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active')
        })
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active')

        // Actualizar contenido
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active')
        })
        document.getElementById(`${tabName}-tab`).classList.add('active')

        console.log(`📱 Cambiado a tab: ${tabName}`)
      }
    }

    // 🆕 GESTOR DE COMENTARIOS
    const CommentsManager = {
      getCurrentUser() {
        return currentUser
      },

      init() {
        this.updateUserInfo()
        this.loadComments(currentId)
      },

      updateUserInfo() {
        const user = this.getCurrentUser()
        const userInfoEl = document.getElementById('userInfo')
        
        userInfoEl.innerHTML = `
          Comentando como: <strong>${user.name}</strong>
          ${user.isInstructor ? '<span class="instructor-badge">👨‍🏫 Instructor</span>' : ''}
        `
      },

      async loadComments(videoId) {
        try {
          console.log(`💬 Cargando comentarios para video ${videoId}`)
          
          const { data: comments, error } = await supabase
            .from('comments')
            .select('*')
            .eq('video_id', videoId)
            .order('created_at', { ascending: false })

          if (error) {
            console.error('Error cargando comentarios:', error)
            return
          }

          console.log(`📝 ${comments?.length || 0} comentarios encontrados`)
          
          const grouped = this.groupComments(comments || [])
          this.renderComments(grouped)
          
        } catch (error) {
          console.error('Error en loadComments:', error)
        }
      },

      groupComments(comments) {
        const grouped = []
        const commentMap = {}
        
        // Crear mapa de comentarios
        comments.forEach(comment => {
          commentMap[comment.id] = { ...comment, replies: [] }
        })
        
        // Agrupar respuestas
        comments.forEach(comment => {
          if (comment.parent_id === null) {
            // Comentario principal
            grouped.push(commentMap[comment.id])
          } else {
            // Respuesta - agregar al comentario principal
            const parentComment = commentMap[comment.parent_id]
            if (parentComment) {
              parentComment.replies.push(commentMap[comment.id])
            }
          }
        })
        
        return grouped
      },

      renderComments(groupedComments) {
        const container = document.getElementById('comments-list')
        
        if (groupedComments.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <iconify-icon icon="mdi:comment-outline"></iconify-icon>
              <p>No hay comentarios aún</p>
              <p>¡Sé el primero en comentar!</p>
            </div>
          `
          return
        }
        
        container.innerHTML = groupedComments.map(comment => 
          this.createCommentHTML(comment)
        ).join('')
      },

      createCommentHTML(comment) {
        return `
          <div class="comment-thread">
            <div class="comment main-comment">
              <div class="comment-header">
                <strong>${comment.user_name}</strong>
                ${comment.is_instructor ? '<span class="instructor-badge">👨‍🏫 Instructor</span>' : ''}
                <span class="comment-time">${this.formatTime(comment.created_at)}</span>
              </div>
              <div class="comment-message">${comment.message}</div>
              <div class="comment-actions">
                ${this.getCurrentUser().isInstructor ? `
                  <button onclick="CommentsManager.showReplyForm(${comment.id})">
                    💬 Responder
                  </button>
                ` : ''}
              </div>
            </div>
            
            ${comment.replies.map(reply => `
              <div class="comment reply-comment">
                <div class="comment-header">
                  <strong>${reply.user_name}</strong>
                  ${reply.is_instructor ? '<span class="instructor-badge">👨‍🏫 Instructor</span>' : ''}
                  <span class="comment-time">${this.formatTime(reply.created_at)}</span>
                </div>
                <div class="comment-message">${reply.message}</div>
              </div>
            `).join('')}
            
            <div id="reply-form-${comment.id}" class="reply-form" style="display: none;">
              <textarea placeholder="Escribe tu respuesta como instructor..."></textarea>
              <button onclick="CommentsManager.submitReply(${comment.id})">Enviar Respuesta</button>
              <button onclick="CommentsManager.hideReplyForm(${comment.id})">Cancelar</button>
            </div>
          </div>
        `
      },

      formatTime(dateString) {
        const date = new Date(dateString)
        const now = new Date()
        const diffMs = now - date
        const diffMins = Math.floor(diffMs / 60000)
        const diffHours = Math.floor(diffMins / 60)
        const diffDays = Math.floor(diffHours / 24)

        if (diffMins < 1) return 'Ahora'
        if (diffMins < 60) return `${diffMins}m`
        if (diffHours < 24) return `${diffHours}h`
        if (diffDays < 7) return `${diffDays}d`
        
        return date.toLocaleDateString('es-ES', { 
          day: 'numeric', 
          month: 'short' 
        })
      },

      async submitNewComment() {
        const textarea = document.getElementById('new-comment')
        const message = textarea.value.trim()
        
        if (!message) {
          alert('Por favor escribe un comentario')
          return
        }

        await this.addComment(currentId, message)
        textarea.value = ''
      },

      async addComment(videoId, message, parentId = null) {
        const user = this.getCurrentUser()
        
        // Validar si puede responder
        if (parentId && !user.isInstructor) {
          alert('Solo el instructor puede responder a comentarios')
          return
        }

        try {
          const { data, error } = await supabase
            .from('comments')
            .insert({
              video_id: parseInt(videoId),
              message,
              parent_id: parentId,
              user_id: user.id,
              user_name: user.name,
              is_instructor: user.isInstructor
            })

          if (error) {
            console.error('Error agregando comentario:', error)
            alert('Error al enviar comentario')
            return
          }

          console.log('✅ Comentario agregado:', data)
          this.loadComments(videoId)
          
        } catch (error) {
          console.error('Error en addComment:', error)
          alert('Error al enviar comentario')
        }
      },

      showReplyForm(commentId) {
        const user = this.getCurrentUser()
        
        if (!user.isInstructor) {
          alert('Solo el instructor puede responder a comentarios')
          return
        }
        
        document.getElementById(`reply-form-${commentId}`).style.display = 'block'
      },

      hideReplyForm(commentId) {
        document.getElementById(`reply-form-${commentId}`).style.display = 'none'
      },

      async submitReply(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`)
        const textarea = replyForm.querySelector('textarea')
        const message = textarea.value.trim()
        
        if (!message) {
          alert('Por favor escribe una respuesta')
          return
        }

        await this.addComment(currentId, message, commentId)
        textarea.value = ''
        this.hideReplyForm(commentId)
      }
    }

    // Tu código existente para videos relacionados...
    const relatedItemsRefs = []
    const videoElement = document.getElementById('mainVideo')
    const canvas = document.getElementById('captureCanvas')
    const ctx = canvas.getContext('2d')
    const listEl = document.getElementById('relatedList')
    const titleEl = document.getElementById('mainTitle')

    // [Aquí va todo tu código existente del PreviewProcessor y loadData]
    // Lo mantuve igual, solo cambié dónde se renderizan los videos relacionados

    const formatDuration = (seconds) => {
      if (!seconds || isNaN(seconds)) return 'N/A'
      const m = Math.floor(seconds / 60)
      const s = Math.floor(seconds % 60)
      return `${m}:${s < 10 ? '0' : ''}${s}`
    }

    // Código simplificado para demo - mantén tu loadData original
    const loadData = async () => {
      // Simulación de datos para demo
      titleEl.innerText = 'Video de ejercicio demo'
      document.getElementById('mainInfo').innerHTML = `
        <span>
          <iconify-icon icon="mdi:clock-time-four-outline" style="font-size:13px;"></iconify-icon>
          Duración: 5:30
        </span>
        <span>
          <iconify-icon icon="mdi:arm-flex-outline" style="font-size:13px;"></iconify-icon>
          Dificultad: Intermedio
        </span>
      `

      // Agregar algunos videos de ejemplo en la tab de relacionados
      listEl.innerHTML = `
        <div class="related-item active">
          <img src="https://via.placeholder.com/140x80" alt="Preview">
          <div class="related-texts">
            <div class="name">Ejercicio actual - Video demo</div>
            <div class="duration">Duración: 5:30</div>
          </div>
        </div>
        <div class="related-item">
          <img src="https://via.placeholder.com/140x80" alt="Preview">
          <div class="related-texts">
            <div class="name">Siguiente ejercicio</div>
            <div class="duration">Duración: 4:15</div>
          </div>
        </div>
      `
    }

    // 🚀 INICIALIZACIÓN
    document.addEventListener('DOMContentLoaded', () => {
      TabsManager.init()
      CommentsManager.init()
      loadData()
    })

    // Hacer CommentsManager global para los botones
    window.CommentsManager = CommentsManager
  </script>
</body>
</html>